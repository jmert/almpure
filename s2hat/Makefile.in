# Build script written by Justin Willmert and is not part of the original
# S2HAT/PS2HAT libraries.

.PHONY: clean
all: libs2hat.a libs2hat.so

# Choose CPU platform:
#   SP3, T3E, SX5, O2K, opteron, powermac, x86_32, x86_64
PLATFORM := x86_64
# Choose the MPI library: (Optional)
#   MPICH, OPEN_MPI, LAM_MPI
MPILIB := OPEN_MPI

AR = ar
RANLIB = @RANLIB@
MPIFC = @MPIFC@
MPICC = @MPICC@

# Set compiler defines for the choices set above.
DFLAGS = -D$(PLATFORM) -D@WITH_FFT@
ifdef MPILIB
	DFLAGS += -D$(MPILIB)
endif

# Set the build flags used in compile rules below
FFLAGS += -O3 -std=gnu -fPIC $(DFLAGS) \
	-fno-second-underscore -ffixed-line-length-none -ffree-line-length-none
CFLAGS += -O3 -fPIC $(DFLAGS) @FFT_CFLAGS@
LDFLAGS += -lgfortran @FFT_LIBS@

OBJECTS = \
	s2hat_defs.o s2hat_types_internal.o s2hat_pixelization.o \
	s2hat_toolbox.o s2hat_alm2map.o s2hat_map2alm.o \
	s2hat_c_interface.o s2hat_c_wrappers.o \
	s2hat_map2purealm.o
# Dependencies on building particular objects. The object list above is
# ordered sufficiently to build serially, but the rules below are required
# to permit multi-threaded builds (i.e. -j4)
s2hat_alm2map.o: s2hat_toolbox.o s2hat_types_internal.o
s2hat_c_interface.o: s2hat_alm2map.o s2hat_map2alm.o s2hat_pixelization.o \
					 s2hat_pixelization.o
s2hat_map2alm.o: s2hat_alm2map.o s2hat_toolbox.o s2hat_types_internal.o
s2hat_pixelization.o: s2hat_types_internal.o
s2hat_toolbox.o: s2hat_types_internal.o
s2hat_types_internal.o: s2hat_defs.o

libs2hat.a: $(OBJECTS)
	$(AR) rcs $@ $^

# Target required for Matlab's mex functions which includes the FFTW functions
# statically so that the Matlab-internal functions aren't used instead.
libs2hat_fftw.a: libs2hat.a
	FFTW_STATIC="$(shell $(CC) $(LDFLAGS) --print-file-name=libfftw3.a)"; \
	echo -e "CREATE $@\nADDLIB $^\nADDLIB $$FFTW_STATIC\nSAVE\nEND" | ar -M
	$(RANLIB) $@

libs2hat.so: $(OBJECTS)
	$(MPICC) -o $@ -shared $(CFLAGS) $^ $(LDFLAGS)

clean:
	rm -f *.so *.a *.o *.mod

%.o: %.f90
	$(MPIFC) $(FFLAGS) -o $@ -c $<

%.o: %.F90
	$(MPIFC) $(FFLAGS) -o $@ -c $<

%.o: %.c
	$(MPICC) $(CFLAGS) -o $@ -c $<

